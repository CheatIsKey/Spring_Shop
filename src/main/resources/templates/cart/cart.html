<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <meta charset="UTF-8">
  <title>장바구니</title>
  <link th:href="@{/webjars/bootstrap/4.5.2/css/bootstrap.min.css}" rel="stylesheet"/>
</head>
<body>
<div class="container mt-4">

  <!-- 상단 헤더 -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">장바구니</h2>
    <a class="btn btn-outline-secondary" th:href="@{/}">홈으로 돌아가기</a>
  </div>

  <!-- 알림 메시지 (FlashAttribute: toast / error) -->
  <div th:if="${toast}" class="alert alert-success" th:text="${toast}"></div>
  <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

  <!-- 요약 -->
  <div class="mb-3">
    <span>상품 종류: <strong th:text="${cart.itemCount}">0</strong></span>
    <span class="ml-3">총 수량: <strong th:text="${cart.totalQuantity}">0</strong></span>
  </div>

  <!-- 목록 테이블 -->
  <table class="table table-bordered">
    <thead class="thead-light">
    <tr>
      <th>상품</th>
      <th style="width:170px;">수량</th>
      <th>가격</th>
      <th>소계</th>
      <th style="width:90px;"></th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="ci : ${cart.items}">
      <td class="align-middle">
        <img th:if="${ci.imageUrl != null}" th:src="${ci.imageUrl}" alt="이미지" width="60" class="mr-2"/>
        <span th:text="${ci.name}">상품명</span>
      </td>
      <td class="align-middle">
        <form th:action="@{/cart/change}" method="post" class="form-inline">
          <input type="hidden" name="itemId" th:value="${ci.itemId}"/>
          <input type="number" name="quantity" min="0" th:value="${ci.quantity}"
                 class="form-control form-control-sm mr-2" style="width:80px;"/>
          <button type="submit" class="btn btn-sm btn-outline-primary">변경</button>
          <!-- CSRF -->
          <input type="hidden" th:if="${_csrf != null}"
                 th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        </form>
      </td>
      <td class="align-middle"
          th:text="${#numbers.formatDecimal(ci.price, 0, 'COMMA', 0, 'POINT')}">0</td>
      <td class="align-middle"
          th:text="${#numbers.formatDecimal(ci.subtotal, 0, 'COMMA', 0, 'POINT')}">0</td>
      <td class="align-middle">
        <form th:action="@{/cart/remove}" method="post">
          <input type="hidden" name="itemId" th:value="${ci.itemId}"/>
          <button type="submit" class="btn btn-sm btn-danger">삭제</button>
          <!-- CSRF -->
          <input type="hidden" th:if="${_csrf != null}"
                 th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        </form>
      </td>
    </tr>
    <tr th:if="${#lists.isEmpty(cart.items)}">
      <td colspan="5" class="text-center text-muted">장바구니가 비어 있습니다.</td>
    </tr>
    </tbody>
  </table>

  <!-- 하단 액션 바 + 배송 정보 + 주문 -->
  <div class="border rounded p-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <form th:action="@{/cart/clear}" method="post" class="mb-0">
        <button type="submit" class="btn btn-outline-secondary">비우기</button>
        <!-- CSRF -->
        <input type="hidden" th:if="${_csrf != null}"
               th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
      </form>

      <h4 class="mb-0">
        총액: <span th:text="${#numbers.formatDecimal(cart.total, 0, 'COMMA', 0, 'POINT')}">0</span> 원
      </h4>
    </div>

    <!-- 주문 생성 폼: /orders + 주소 필수 -->
    <form th:action="@{/orders}" method="post" class="mt-3">
      <div class="form-row">
        <div class="form-group col-md-4">
          <label for="city">도시</label>
          <input id="city" name="city" type="text" class="form-control"
                 placeholder="예) 서울" required />
        </div>
        <div class="form-group col-md-4">
          <label for="state">시/도</label>
          <input id="state" name="state" type="text" class="form-control"
                 placeholder="예) 강남구" required />
        </div>
        <div class="form-group col-md-4">
          <label for="street">도로명/상세주소</label>
          <input id="street" name="street" type="text" class="form-control"
                 placeholder="예) 테헤란로 123 5층" required />
        </div>
      </div>

      <div class="text-right">
        <button type="submit" class="btn btn-success"
                th:disabled="${#lists.isEmpty(cart.items)}">주문하기</button>
      </div>

      <!-- CSRF -->
      <input type="hidden" th:if="${_csrf != null}"
             th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
    </form>
  </div>

<script th:src="@{/webjars/jquery/3.5.1/jquery.min.js}"></script>
<script th:src="@{/webjars/bootstrap/4.5.2/js/bootstrap.bundle.min.js}"></script>
</body>
</html>
